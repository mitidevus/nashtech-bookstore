extends ../partials/dashboard-layout

block content
    - var breadcrumbs = [{ text: 'Dashboard', href: '/' }, 'Books']
    include ../partials/breadcrumbs

    div(class="w-full h-full flex flex-col items-center mt-4")
        div(class="w-full divide-y divide-gray-200 border rounded-lg overflow-hidden shadow-md")
            div(class="flex items-center justify-between py-4 px-6")
                h1(class="text-lg font-semibold text-gray-800") Books
                button(id="add-book-btn" class="primary-btn" onclick="openModal()")
                    i.lni.lni-plus
                    span Add Book


            table(class="min-w-full divide-y divide-gray-200")
                - var columns = ['ID', 'Name', 'Price', 'Discount', 'Sold', 'Created At', 'Updated At']
                include ../partials/head-table

                - var rows = data
                include ../partials/body-table
                    block items
                        each book in data
                            tr(key=book.id class="hover:bg-gray-50 hover:text-[#7F56D9] cursor-pointer" onclick=`window.location='/books/${book.id}'`)  
                                td(class="py-4 px-6")= book.id
                                td(class="py-4 px-6 max-w-[300px] flex items-center gap-4")
                                    img(src=`${book.image}` alt=book.name class="w-14 h-14 object-cover rounded-md border border-gray-200")
                                    span(class="block")= book.name
                                td(class="py-4 px-6")
                                    if book.discountPrice
                                        span(class="block text-gray-400 line-through")= book.price
                                        span(class="block")= book.discountPrice
                                    else
                                        span(class="block")= book.price
                                td(class="py-4 px-6")= `${book.discountPercentage}%`
                                td(class="py-4 px-6")= book.soldQuantity
                                td(class="py-4 px-6")= book.createdAt
                                td(class="py-4 px-6")= book.updatedAt

            div(class="py-4 px-6")
                include ../partials/pagination.pug

    - var modalTitle = 'Add Book'
    include ../partials/modal
        block modalFormContent
            form(id="add-book-form" onsubmit="addBook(event)")
                div(class="grid grid-cols-2 gap-4")
                    div(class="col-span-2")
                        label(for="name" class="block text-gray-700 text-sm font-medium mb-2") Name
                        input(id="name" type="text" name="name" class="modal-input" autocomplete="off")

                    div(class="col-span-2")
                        label(for="price" class="block text-gray-700 text-sm font-medium mb-2") Price
                        input(id="price" type="text" name="price" class="modal-input" autocomplete="off")

                    div(class="col-span-2")
                        label(for="categories" class="block text-gray-700 text-sm font-medium mb-2") Categories
                        select(id="categories" name="categories" class="modal-input" multiple size=2.5)
                            each category in categories
                                option(value=category.id)= category.name

                    div(class="col-span-2")
                        label(for="authors" class="block text-gray-700 text-sm font-medium mb-2") Authors
                        select(id="authors" name="authors" class="modal-input" multiple size=2.5)
                            each author in authors
                                option(value=author.id)= author.name

                    div(class="col-span-4")
                        label(for="description" class="block text-gray-700 text-sm font-medium mb-2") Description
                        textarea(id="description" type="text" name="description" class="modal-input" autocomplete="off" rows="2")

                    div(class="col-span-4")
                        include ../partials/image-input

                div(class="flex gap-2 justify-end")
                    button(type="button" class="py-2 px-4 border rounded-md bg-gray-50 text-gray-500 font-medium hover:bg-gray-100" onclick="closeModal()") Cancel
                    button(type="submit" class="py-2 px-4 bg-[#7F56D9] text-white font-medium hover:bg-[#926FDF] rounded focus:outline-none focus:shadow-outline") Add

    script.
        async function addBook(event) {
            event.preventDefault();

            const form = document.getElementById('add-book-form');
            const formData = new FormData(form);

            const categorySelect = document.getElementById('categories');
            const selectedCategories = Array.from(categorySelect.selectedOptions).map(option => option.value);
            formData.set('categoryIds', selectedCategories.join(','));

            const authorSelect = document.getElementById('authors');
            const selectedAuthors = Array.from(authorSelect.selectedOptions).map(option => option.value);
            formData.set('authorIds', selectedAuthors.join(','));

            try {
                const response = await fetch('/books', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    console.log('Added book successfully');
                    closeModal();
                    window.location.reload();
                } else {
                    console.error('Failed to add book');
                }
            } catch (error) {
                console.error('Failed to add book');
            }
        }